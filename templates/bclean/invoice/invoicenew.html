{extends file="layout.html"}
{block name=title}::: LMS :{$layout.pagetitle|striphtml} :::{/block}
{block name=module_content}
    <!--// $Id$ //-->
    <H1>{$layout.pagetitle}</H1>
        {if $newinvoice}
        <SCRIPT type="text/javascript">
            <!--
            window.open('?m=invoice&id={$newinvoice.invoice}&original={$newinvoice.original}&copy={$newinvoice.copy}');
            //-->
        </SCRIPT>
    {/if}
    {include file="calendar_js.html"}
    <script type="text/javascript">
        <!--
        function setItem(index)
        {
            var e = document.additem;
        {foreach from=$tariffs item=tariff}
            if (index == {$tariff.id})
            {
                e.name.value = '{$tariff.name|escape}    ';
                e.taxid.value = '{$tariff.taxid}    ';
                e.valuebrutto.value = '{$tariff.value}    ';
                e.prodid.value = '{$tariff.prodid}    ';
                e.tariffid.value = '{$tariff.id}';
                e.count.value = 1;
                return;
            }
        {/foreach}
            if (index == 0)
            {
                e.name.value = '';
                e.valuebrutto.value = '';
                e.prodid.value = '';
                e.tariffid.value = '';
                e.count.value = 1
            }
        }

        function saveheader()
        {
            if (document.setcustomer.customer)
                if (document.setcustomer.customer.value != 0)
                    document.setcustomer.customerid.value = document.setcustomer.customer.value;

            document.setcustomer.submit();
        }

        function setPayTime(type)
        {
            var list = document.setcustomer.elements['invoice[paytime_default]'];
            list[0].checked = type ? true : false;
            list[1].checked = type ? false : true;
            document.getElementById('paytime').style.visibility = type ? 'hidden' : 'visible';
        }

        function printinvoice()
        {
            var add = "";
            if (document.additem.original.checked)
                add += "&original=1";
            if (document.additem.copy.checked)
                add += "&copy=1";

            document.additem.action = "?m=invoicenew&action=save&print=1" + add;
            document.additem.submit();
        }

        function deadline_calendar(elem)
        {
            var ts = get_cdate(), deadline = parseInt(elem.value);

            // add paytime days to settlement date
            ts.setDate(ts.getDate() + (deadline || 0));
            // display calendar
            cal3.popup(cal3.gen_date(ts));
        }

        function get_cdate()
        {
            var ts = document.setcustomer.elements['invoice[cdate]'].value;

            if (!ts.match(/^[0-9]{4}\/[0-9]{2}\/[0-9]{2}$/))
                ts = '{$smarty.now|date_format:"%Y/%m/%d"}';

            return cal3.prs_date(ts);
        }
        //-->
    </script>
    {$default_printpage = ConfigHelper::getConfig('invoices.default_printpage')}
    {$default_taxrate   = ConfigHelper::getConfig('phpui.default_taxrate')}
    <FORM class="form-inline" name="setcustomer" method="POST" action="?m=invoicenew&amp;action=setcustomer">
        <INPUT type="submit" class="hiddenbtn">

        <div class="card">
            <div class="card-header">{trans("Main Information:")}</div>
            <div class="card-block">
                <div class="form-group">
                    <label for="firstName">{trans("Invoice number:")}</label>
                    <INPUT class="form-control form-control-sm" type="text" name="invoice[number]" value="{$invoice.number}" {tip text="Enter invoice number. WARNING! Changing this number can be DANGEROUS! (leave this field empty to obtain next number)" trigger="number"}>
                    {if $numberplanlist}
                        <SELECT class="form-control form-control-sm" name="invoice[numberplanid]" {tip text="Select numbering plan"}>
                            {foreach item=plan from=$numberplanlist}
                                {assign var=period value=$plan.period}
                                <OPTION value="{$plan.id}"{if $plan.id==$invoice.numberplanid} SELECTED{/if}>{number number=$plan.next template=$plan.template time=$invoice.cdate} ({$_NUM_PERIODS.$period})</OPTION>
                                {/foreach}
                        </SELECT>
                    {else}
                        <INPUT type="hidden" name="invoice[numberplanid]" value="0">
                    {/if}                                
                </div>

                <hr>

                <div class="form-group">
                    <label for="firstName">{trans("Settlement date:")}</label>
                    <INPUT class="form-control form-control-sm" type="text" name="invoice[cdate]" value="{$invoice.cdate|date_format:"%Y/%m/%d"}" {tip class="calendar" text="Enter date of settlement in YYYY/MM/DD format (empty field means current date) or click to select it from calendar" trigger="cdate"}>
                    {if $invoice.cdatewarning}
                        <INPUT type="hidden" name="invoice[cdatewarning]" value="1">
                    {/if}                              


                    <label for="firstName">{trans("Sale date:")}</label>
                    <INPUT class="form-control form-control-sm" type="text" name="invoice[sdate]" value="{$invoice.sdate|date_format:"%Y/%m/%d"}" {tip class="calendar" text="Enter date of sale in YYYY/MM/DD format (empty field means current date) or click to select it from calendar" trigger="sdate"}>
                </div>

                <hr>

                <div class="form-group">
                    {trans("Deadline:")}
                    <INPUT type="radio" name="invoice[paytime_default]" value="1" id="type1" onchange="setPayTime(1)"{if !isset($invoice.paytime_default) || $invoice.paytime_default} checked{/if}><label for="type1">{trans("default")}</label>
                    <INPUT type="radio" name="invoice[paytime_default]" value="0" id="type0" onchange="setPayTime(0)"{if isset($invoice.paytime_default) && !$invoice.paytime_default} checked{/if}><label for="type0">{trans("other")}</label>
                    <INPUT type="text" name="invoice[paytime]" value="{$invoice.paytime}" size="5" ID="paytime" onclick="deadline_calendar(this)"
                           {if !isset($invoice.paytime_default) || $invoice.paytime_default} style="visibility: hidden"{/if} {tip text="Enter deadline in days (optional)" trigger="paytime"}>


                    {trans("Payment type:")}
                    <SELECT name="invoice[paytype]" {tip text="Select payment type" trigger="paytype"}>
                        <OPTION value=""{if !$invoice.paytype} selected{/if}>- {trans("default")} -</OPTION>
                            {foreach from=$_PAYTYPES item=item key=key}
                            <OPTION value="{$key}"{if $invoice.paytype==$key} selected{/if}>{$item}</OPTION>
                            {/foreach}
                    </SELECT>
                </div>

                <hr>
                <div class="form-group">
                    {trans("Customer:")}
                    {if isset($customer.id)}
                        {customerlist form="setcustomer" customers=$customers selected=$customer.id selectname="customer" inputname="customerid"}
                    {else}
                        {customerlist form="setcustomer" customers=$customers selected=$invoice.customerid selectname="customer" inputname="customerid"}
                    {/if}  
                </div>
                <hr>

                <A class="btn btn-sm btn-danger" href="javascript:saveheader();">{trans("Submit")}</A>
            </div>
        </div>   
    </FORM>

    {if $customer}
        <div class="card">
            <div class="card-header">
                {$customer.customername}
                {if $customer.balance < 0}
                    <span class="text-danger pull-xs-right">
                        <strong>{trans("Warning negative saldo")}:</strong> {$customer.balance|money_format}
                    </span>
                {/if}   
            </div>
            <div class="card-block">

                {$customer.address}, {$customer.zip}, {$customer.city}

            </div>
        </div>
    {/if}

    {if $covenantlist}
        <FORM name="additemlist" method="POST" action="?m=invoicenew&amp;action=additemlist">
            <TABLE class="table table-bordered">
                <THEAD>
                    <TR>
                        <TD class="bold">
                            <IMG src="img/money.gif" alt="">
                            {trans("Invoiceless liabilities:")}
                        </TD>
                    </TR>
                </THEAD>
                <TBODY>
                    <TR>
                        <TD style="width: 100%;">
                            <TABLE cellpadding="5" cellspacing="0" width="100%">
                                <TR>
                                    <TD style="width: 1%;">{trans("Date:")}</TD>
                                    <TD style="width: 92%;">{trans("Name of product, commodity or service:")}</TD>
                                    <TD style="width: 1%;" class="text-right nobr">{trans("Product ID:")}</TD>
                                    <TD style="width: 1%;" class="text-right">{trans("Amount:")}</TD>
                                    <TD style="width: 1%;" class="text-right">{trans("Unit:")}</TD>
                                    <TD style="width: 1%;" class="text-right nobr">{trans("Net Value:")}</TD>
                                    <TD style="width: 1%;" class="text-right nobr">{trans("Tax:")}</TD>
                                    <TD style="width: 1%;" class="text-right nobr">{trans("Gross Value:")}</TD>
                                    <TD style="width: 1%;">&nbsp;</TD>
                                </TR>
                                {cycle values="light,lucid" print=false}
                                {section name=covenantlist loop=$covenantlist}
                                    <TR class="highlight {cycle}"  >
                                        <TD class="nobr">{$covenantlist[covenantlist].time|date_format:"%Y/%m/%d"}</TD>
                                        <TD>{$covenantlist[covenantlist].comment}</TD>
                                        <TD class="text-right"><INPUT type="text" name="l_prodid[{$covenantlist[covenantlist].cashid}]" value="{ConfigHelper::getConfig('phpui.default_prodid', '', true)}" size="6"></TD>
                                        <TD class="text-right"><INPUT type="text" name="l_count[{$covenantlist[covenantlist].cashid}]" value="1" size="3"></TD>
                                        <TD class="text-right"><INPUT type="text" name="l_jm[{$covenantlist[covenantlist].cashid}]" value="{trans(ConfigHelper::getConfig('payments.default_unit_name'))}" size="3"></TD>
                                        <TD class="text-right nobr">{$covenantlist[covenantlist].net|money_format}</TD>
                                        <TD class="text-right nobr">{$covenantlist[covenantlist].tax}</TD>
                                        <TD class="text-right nobr">{$covenantlist[covenantlist].value|money_format}</TD>
                                        <TD class="text-right">
                                            <INPUT TYPE="checkbox" NAME="marks[]" VALUE="{$covenantlist[covenantlist].cashid}">
                                        </TD>
                                    </TR>
                                {/section}
                                <TR>
                                    <TD colspan="2" class="nobr">
                                        <INPUT type="checkbox" name="allbox" id="allbox" onchange="CheckAll('additemlist', this)" value="1"><label for="allbox">{trans("Check All")}</label>
                                    </TD>
                                    <TD class="text-right nobr" colspan="7">
                                        <A href="javascript:document.additemlist.submit();">{trans("Add items")} <IMG src="img/save.gif" alt=""></A>
                                    </TD>
                                </TR>
                            </TABLE>
                        </TD>
                    </TR>
                </TBODY>
            </TABLE>
        </FORM>
    {/if}

    <FORM method="post" action="?m=invoicenew&amp;action=additem" name="additem" id="additem">
        <TABLE class="table table-bordered table-sm table-striped table-hover">
            <thead class="thead-inverse">
                <TR>
                    <th>
                        {trans("No.")}
                    </th>
                    <th>
                        {trans("Name of product, commodity or service:")}
                    </th>
                    <th>
                        {trans("Product ID:")}
                    </th>
                    <th>
                        {trans("Amount:")}<BR>
                        {trans("Unit:")}
                    </th>
                    <th>
                        {trans("Discount:")}
                    </th>
                    <th>
                        {trans("Net Price:")}<BR>
                        {trans("Net Value:")}
                    </th>
                    <th>
                        {trans("Tax:")}
                    </th>
                    <th>
                        {trans("Gross Price:")}<BR>
                        {trans("Gross Value:")}
                    </th>
                    <th>
                        &nbsp;
                    </th>
                </TR>
            </THEAD>
            <TR>
                <TD>
                    <INPUT type="submit" class="hiddenbtn">
                    <INPUT type="hidden" name="tariffid" value="0">
                    {count($contents) + 1}.
                </TD>
                <TD>
                    {block name="invoicenew-tariff-selection"}
                        <INPUT class="form-control form-control-sm" type="text" name="name" id="name" placeholder="{trans('Enter description or select tariff from the list')}">
                        <SELECT class="form-control form-control-sm" name="ttariffid" onchange="setItem(document.additem.ttariffid.value)" {tip text="Enter description or select tariff from the list"}>
                            <OPTION value="0">-</OPTION>
                                {foreach from=$tariffs item=tariff}
                                <OPTION value="{$tariff.id}">{$tariff.name} ({$tariff.value|money_format})</OPTION>
                                {/foreach}
                        </SELECT>{*&nbsp;<A href="javascript:setItem(document.additem.ttariffid.value)">{trans("Select")}</A>*}
                    {/block}
                </TD>
                <TD>
                    <INPUT class="form-control form-control-sm" type="text" name="prodid">
                </TD>
                <TD>
                    <INPUT class="form-control form-control-sm" type="text" name="count" value="1">
                    <INPUT class="form-control form-control-sm" type="text" name="jm" value="{trans(ConfigHelper::getConfig('payments.default_unit_name'))}">
                </TD>
                <TD class="text-right">
                    <INPUT class="form-control form-control-sm" type="text" name="discount" placeholder="{trans('Enter discount percentage or amount')}">
                    <SELECT class="form-control form-control-sm" name="discount_type">
                        {foreach from=$_DISCOUNTTYPES item=item key=key}
                            <OPTION value="{$key}">{$item}</OPTION>
                            {/foreach}
                    </SELECT>
                </TD>
                <TD>
                    <INPUT class="form-control form-control-sm" type="text" name="valuenetto" placeholder="{trans('Enter unitary value without discount')}">
                </TD>
                <TD>
                    <SELECT class="form-control form-control-sm" name="taxid" {tip text="Select Tax rate"}>
                        {foreach item=tax from=$taxeslist}
                            <OPTION value="{$tax.id}"{if $tax.value == $default_taxrate} selected{/if}>{$tax.label}</OPTION>
                            {/foreach}
                    </SELECT>
                </TD>
                <TD>
                    <INPUT class="form-control form-control-sm" type="text" name="valuebrutto" placeholder="{trans('Enter unitary value without discount')}">
                </TD>
                <TD>
                    <A class="btn btn-sm btn-success" href="javascript:document.additem.submit();" title="{trans('Add item')}"><i class="fa fa-fw fa-plus-circle"></i></A>
                </TD>
            </TR>
        </table>


        <INPUT class="form-control form-control-sm" type="checkbox" name="original" id="original"{if preg_match('/original/i', $default_printpage)} checked{/if}><label for="original">{trans("original")}</label>
        <INPUT class="form-control form-control-sm" type="checkbox" name="copy" id="copy"{if preg_match('/copy/i', $default_printpage)} checked{/if}><label for="copy">{trans("copy")}</label>&nbsp;
        <A class="btn btn-sm btn-secondary" href="?m=invoicelist">{trans("Cancel")}</A>
        <A class="btn btn-sm btn-warning" href="?m=invoicenew&amp;action=init">{trans("Clear Contents")}</A> 
            {if !$customer}
            <A class="btn btn-sm btn-danger" href="javascript:alert('{trans("Customer not selected!")}');">{trans("Save")}</A>
            <A class="btn btn-sm btn-danger" href="javascript:alert('{trans("Customer not selected!")}');">{trans("Save & Print")}</A>
            {elseif !$contents}
            <A class="btn btn-sm btn-danger" href="javascript:alert('{trans("Invoice have no items!")}');">{trans("Save")}</A>
            <A class="btn btn-sm btn-danger" href="javascript:alert('{trans("Invoice have no items!")}');">{trans("Save & Print")}</A>
            {else}
            <A class="btn btn-sm btn-danger" href="?m=invoicenew&amp;action=save">{trans("Save")}</A>
            <A class="btn btn-sm btn-danger" href="javascript:printinvoice()">{trans("Save & Print")}</A>
            {/if}

    </FORM>
    <hr>
    <TABLE class="table table-bordered table-sm table-striped table-hover">
        {foreach from=$contents item=item}
            <TR>
                <TD>
                    {counter}.
                </TD>
                <TD>
                    {$item.name}
                </TD>
                <TD>
                    {$item.prodid}
                </TD>
                <TD>
                    {$item.count|string_format:"%.2f"}<BR>
                    {$item.jm}
                </TD>
                <TD>
        {if $item.pdiscount != 0}{$item.pdiscount|string_format:"%.2f%%"}{else}{if $item.vdiscount != 0}{$item.vdiscount|money_format}{/if}{/if}
    </TD>
    <TD>
        {$item.valuenetto|money_format}<BR>
        {$item.s_valuenetto|money_format}
    </TD>
    <TD>
        {$item.tax}
    </TD>
    <TD>
        {$item.valuebrutto|money_format}<BR>
        {$item.s_valuebrutto|money_format}
    </TD>
    <TD>
        <A class="btn btn-sm btn-danger" href="?m=invoicenew&amp;action=deletepos&posuid={$item.posuid}" title="{trans('Remove this item from list')}"><i class="fa fa-fw fa-minus-circle"></i></A>
    </TD>
</TR>
{foreachelse}
    <TR>
        <TD colspan="9" class="empty-table">
            <P>{trans("Invoice have no items. Use form below for items addition.")}</P>
        </TD>
    </TR>
{/foreach}
{if $contents}
    <TR>
        <TD>
            {trans("Total:")}
        </TD>
        <TD>
            {sum array=$contents column=s_valuenetto string_format="%01.2f"}
        </TD>
        <TD>
            &nbsp;
        </TD>
        <TD>
            {sum array=$contents column=s_valuebrutto string_format="%01.2f"}
        </TD>
        <TD>
            &nbsp;
        </TD>
    </TR>
{/if}
</TABLE>
<SCRIPT type="text/javascript">
<!--
    deadline_callback = function (val) {
        var ts = get_cdate(), deadline = cal3.prs_date(val);
        deadline = parseInt((deadline - ts) / 86400000);
        document.getElementById('paytime').value = deadline <= 0 ? '' : deadline;
    }
    var cal3 = new calendar(deadline_callback);
    cal3.time_comp = false;
    document.forms['setcustomer'].elements['invoice[number]'].focus();
//-->
</SCRIPT>
{/block}
