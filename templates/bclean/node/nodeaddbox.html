<script type="text/javascript" src="img/netnodehelper.js"></script>
<script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false"></script>
<FORM NAME="nodeadd" ID="nodeadd" METHOD="POST" ACTION="?m=nodeadd{if $customerinfo.id}&ownerid={$customerinfo.id}{/if}">
    <INPUT type="submit" class="hiddenbtn">

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header lead">{trans("Basic data")}</div>
                <div class="card-block">

                    <div class="input-group">
                        <label for="customer">{trans("Customer")}</label>        
                        {customerlist form="nodeadd" customers=$customers selected=$nodedata.ownerid selectname="nodedata[customerid]" inputname="nodedata[ownerid]" selecttip="Assign node to customer"}
                    </div>

                    <hr>       

                    <div class="input-group">
                        <label for="name">{trans("Name")}</label>
                        <INPUT class="form-control" TYPE="TEXT" NAME="nodedata[name]" VALUE="{$nodedata.name}" MAXLENGTH="32" size="30" required {tip text="Enter node name" trigger="name" bold=1}>
                    </div>

                    <hr>

                    <div class="input-group">
                        <label for="network">{trans("Network")}</label>
                        <SELECT class="form-control form-control-sm" name="nodedatanetid" {tip text="Choose network" trigger="netid"}>
                            <OPTION VALUE="0">{trans("- automatic selection -")}</OPTION>
                                {foreach $networks as $net}
                                <OPTION VALUE="{$net.id}" {if $net.id == $nodedata.netid} selected{/if}{if $net.disabled == 1} class="alert"{/if}>{$net.name|truncate:20:"":true}: {$net.address}/{$net.prefix}</OPTION>
                                {/foreach}
                        </SELECT>
                    </div>

                    <hr>

                    <div class="input-group">
                        <label for="ipAddress">{trans("IP address")}</label>
                        <input class="form-control form-control-sm" type="text" name="nodedataipaddr" value="{$nodedata.ipaddr}" required placeholder="Enter IP address">
                        <span class="input-group-btn">
                            <button type="button" class="btn btn-sm btn-primary" onClick="return ipchoosewin(document.nodeadd.nodedataipaddr, document.nodeadd.nodedatanetid);" title="{trans("Click to select IP from the list")}">{trans("Search")}</button>
                        </span>
                    </div>

                    {if ConfigHelper::checkValue(ConfigHelper::checkConfig('phpui.public_ip', 'true'))}
                        <hr>
                        <div class="input-group">
                            <label for="publicIpAddress">{trans("Public IP address")}</label>
                            <input class="form-control form-control-sm" type="text" name="nodedataipaddr_pub" value="{$nodedata.ipaddr_pub}" required placeholder="Enter public IP address (optional)">
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-sm btn-primary" onClick="return ipchoosewin(document.nodeadd.nodedataipaddr_pub, null);" title="{trans("Click to select public IP from the list")}">{trans("Search")}</button>
                            </span>
                        </div>
                    {/if}

                    <hr>

                    <div class="input-group">
                        <label for="macAddress">{trans("MAC address")}</label>
                        <table class="table">
                            {foreach from=$nodedata.macs item=item key=key}
                                <tr id="mac{$key}">
                                    <td>
                                        <input class="form-control form-control-sm" type="text" name="nodedata[macs][{$key}]" value="{$item}" required placeholder="Enter MAC address">
                                        <span class="input-group-btn">
                                            <button type="button" class="btn btn-sm btn-primary" onClick="return macchoosewin(document.nodeadd.elements['nodedata[macs][{$key}]']);" title="{trans("Click to select MAC from the list")}">{trans("Search")}</button>
                                        </span>
                                    </td>
                                </tr>
                            {/foreach}
                        </table>
                        <input class="form-control form-control-sm" TYPE="HIDDEN" ID="macscount" VALUE="{$item@total}">
                        <a type="button" class="btn btn-sm btn-secondary" href="javascript:newmac()">{trans("Add MAC address")}</a>
                    </div>

                    <hr>

                    <div class="input-group">
                        <label for="password">{trans("Password")}</label>
                        <input class="form-control form-control-sm" type="text" name="nodedata[passwd]" value="{$nodedata.passwd}" required placeholder="Enter password (optional)">
                        <span class="input-group-btn">
                            <button type="button" class="btn btn-sm btn-primary" onClick="GenPasswd();" title="{trans("Click to generate random password")}">{trans("Search")}</button>
                        </span>
                    </div>

                    <hr>

                    <div class="input-group">
                        <label for="location">{trans("Location")}</label>
                        <input class="form-control form-control-sm" type="text" name="nodedata[location]" value="{$nodedata.location}" required placeholder="Enter location (optional)">
                        <span class="input-group-btn">
                            <button type="button" class="btn btn-sm btn-primary" onClick="if (check_teryt())
                                        return locationchoosewin('nodedata', 'nodeadd', document.forms['nodeadd'].elements['nodedata[location_city]'].value, document.forms['nodeadd'].elements['nodedata[location_street]'].value, {ConfigHelper::getConfig('phpui.default_teryt_city')});" title="{trans("Click to select location")}">{trans("Search")}</button>
                        </span>
                        <BR>
                        <INPUT class="form-control" type="hidden" name="nodedata[location_city]" value="{$nodedata.location_city}">
                        <INPUT class="form-control" type="hidden" name="nodedata[location_street]" value="{$nodedata.location_street}">
                        <INPUT class="form-control" type="hidden" name="nodedata[location_house]" value="{$nodedata.location_house}">
                        <INPUT class="form-control" type="hidden" name="nodedata[location_flat]" value="{$nodedata.location_flat}">

                        <label for="teryt">{trans("TERRIT-DB")}</label>
                        <INPUT class="form-control" TYPE="checkbox" name="nodedata[teryt]" id="teryt" ononchange="check_teryt('location')"{if $nodedata.teryt} checked{/if}>
                    </div>


                    <hr>

                    <div class="input-group">
                        <label for="nodeGroup">{trans("Node group")}</label>
                        <SELECT class="form-control form-control-sm" NAME="nodedata[nodegroup]" {tip text="Select group to attribute to node" trigger="nodegroup"}>
                            <OPTION VALUE="0">{trans("... select group ...")}</OPTION>
                                {foreach from=$allnodegroups item=group}
                                <OPTION VALUE="{$group.id}" {if $group.id==$nodedata.nodegroup} SELECTED{/if}>{$group.name} ({$group.id|string_format:"%04d"})</OPTION>
                                {/foreach}
                        </SELECT>
                    </div>


                    {if $netdevices}
                        <div class="card">
                            <div class="card-header lead">{trans("Net device")}</div>
                            <div class="card-block">
                                <div class="input-group">
                                    <label for="networkDevice">{trans("Network device")}</label>
                                    <SELECT class="form-control form-control-sm" NAME="nodedata[netdev]" {tip text="Select network device (optional)" trigger="netdev"} onchange="change_netdevice(this.options[this.selectedIndex].value)">
                                        <OPTION VALUE="0"{if !$nodedata.netdev} SELECTED{/if}>{trans("- select device -")}</OPTION>
                                            {section name=netdevices loop=$netdevices}
                                            <OPTION VALUE="{$netdevices[netdevices].id}"{if $netdevices[netdevices].id==$nodedata.netdev} SELECTED{/if}>{$netdevices[netdevices].name} {$netdevices[netdevices].producer}{if $netdevices[netdevices].location} / {$netdevices[netdevices].location}{/if}</OPTION>
                                            {/section}
                                    </SELECT>
                                    <span class="input-group-btn">
                                        <a type="button" class="btn btn-sm btn-primary" onClick="return netDevChooseWin(document.nodeadd.elements['nodedata[netdev]']);" title="{trans("Search device")}">{trans("Search")}</a>
                                        <a type="button" class="btn btn-sm btn-secondary" onClick="return netdevfrommapchoosewin(document.nodeadd.elements['nodedata[netdev]']);" title="{trans("Click to select network device from map")}">{trans("Search on map")}</A>
                                    </span>
                                </div>


                                <div class="input-group">
                                    <label for="portNumber">{trans("Port number")}</label>
                                    <INPUT class="form-control form-control-sm" type="number" name="nodedata[port]" value="{if $nodedata.port}{$nodedata.port}{/if}" title="{trans("Enter port number in device (optional)")}">
                                </div>


                                <div class="input-group">
                                    <label for="linkType">{trans("Link type")}</label>
                                    <SELECT class="form-control form-control-sm" NAME="nodedata[linktype]" id="linktype" {tip trigger="linktype" text="Select link type"} onchange="change_linktype(this.options[this.selectedIndex].value)">
                                        {foreach from=$_LINKTYPES item=item key=key}
                                            <OPTION value="{$key}">{$item}</OPTION>
                                            {/foreach}
                                    </SELECT>
                                </div>

                                <div class="input-group" id="radiosector" style="display: none;"
                                     <label for="radioSector">{trans("Radio sector")}</label>
                                    <SELECT class="form-control form-control-sm" NAME="nodedata[radiosector]"  {tip trigger="radiosector" text="Select radio sector"}>
                                        <OPTION value="0">- {trans("none")} -</OPTION>
                                    </SELECT>
                                </div>

                                <div class="input-group">
                                    <label for="linkTechnology">{trans("Link technology")}</label>
                                    <SELECT class="form-control form-control-sm" NAME="nodedata[linktechnology]" id="linktechnology" {tip trigger="linktechnology" text="Select link technology"}>
                                        <OPTION value="0">{trans("- unknown -")}</OPTION>
                                            {foreach $_LINKTECHNOLOGIES[0] as $linktechnologyidx => $linktechnology}
                                            <OPTION value="{$linktechnologyidx}">{$linktechnology}</OPTION>
                                            {/foreach}
                                    </SELECT>
                                </div>

                                <div class="input-group">
                                    <label for="linkSpeed">{trans("Link speed")}</label>
                                    <SELECT class="form-control form-control-sm" NAME="nodedata[linkspeed]" id="linkspeed" {tip trigger="linkspeed" text="Select link speed"}>
                                        {foreach from=$_LINKSPEEDS item=item key=key}
                                            <OPTION value="{$key}"{if $key==100000} selected{/if}>{$item}</OPTION>
                                            {/foreach}
                                    </SELECT>
                                </div>

                            </div>
                        </div>
                    {/if}
                    <hr>
                    <div class="card">
                        <div class="card-header lead">{trans("Investment project")}</div>
                        <div class="card-block">
                            <div class="input-group">
                                <label for="newInvestmentProject">{trans("New investment project")}</label>
                                <INPUT TYPE="TEXT" NAME="nodedata[projectname]" VALUE="{$nodedata.projectname}" {tip text="Enter new project name" trigger="projectname" } ID="NNprojectname"  />
                            </div>

                            <hr>

                            <div class="input-group">
                                <label for="selectInvestmentProject">{trans("Select investment project")}</label>
                                <SELECT class="form-control" NAME="nodedata[invprojectid]" ID="NNproject" VALUE="{$nodedata.invprojectid}" {tip text="Select project"} onchange="setNNProject();">
                                    <OPTION value="-2" {if ($nodedata.invprojectid == '-2' ) } selected="selected" {/if} >- {trans("none")} -</OPTION>
                                    <OPTION value="-1" {if ($nodedata.invprojectid == '-1' ) } selected="selected" {/if}>{trans("New project")}</OPTION>
                                    <OPTION value="1" {if ($nodedata.invprojectid == '1' ) } selected="selected" {/if}>{trans("From root device")}</OPTION>
                                        {section name=project loop=$NNprojects}
                                        <OPTION VALUE="{$NNprojects[project].id}" {if ($nodedata.invprojectid == $NNprojects[project].id ) } selected="selected" {/if} >{$NNprojects[project].name}</OPTION>
                                        {/section}
                                </SELECT>
                            </div>

                        </div>
                    </div>

                    <hr>


                    <div class="input-group">
                        <IMG SRC="img/options.gif" ALT="">
                        <label for="chkmac">{trans("MAC checking")}:</label><INPUT class="form-control" TYPE="checkbox" NAME="nodedata[chkmac]" VALUE="1" id="chkmac" {tip text="Enable/disable MAC address checking" trigger="chkmac"}{if $nodedata.chkmac} checked{/if}>&nbsp;
                        <label for="halfduplex">{trans("Half duplex")}:</label><INPUT class="form-control" TYPE="checkbox" NAME="nodedata[halfduplex]" VALUE="1" id="halfduplex" {if $nodedata.halfduplex} checked{/if} {tip text="Select transmission mode"}>
                    </div>

                    <hr>

                    <div class="input-group">
                        <IMG SRC="img/netdev.gif" ALT="">
                        {foreach $_SESSIONTYPES as $idx => $sessiontype}
                            <label>{$sessiontype.label} <INPUT class="form-control" TYPE="checkbox" NAME="nodedata[authtype][{$idx}]" value="{$idx}" id="authtype{$idx}" {tip text="`$sessiontype.tip`" trigger="authtype`$idx`"}{if ($nodedata.authtype & $idx) == $idx} checked{/if}></label>&nbsp;
                            {/foreach}
                    </div>

                </div>
            </div>

        </div>
        <div class="col-md-6">
            <img src="img/network.gif" alt="">
            <a href="javascript:set_lat_lon()" accesskey="s">{trans("Determine GPS coordinates automatically")}</a>

            <br>
            <span class="bold">{trans("GPS longitude:")}</span>
            <INPUT class="form-control" ID="longitude" TYPE="text" NAME="nodedata[longitude]" VALUE="{if $nodeinfo.longitude}{$nodeinfo.longitude}{else}{/if}" {tip text="Enter device longitude (optional)"} trigger="longitude">
            <a href="javascript:void(0);" onClick="return gpscoordschoosewin(document.nodeadd.elements['nodedata[longitude]'], document.nodeadd.elements['nodedata[latitude]']);" {tip text="Click to select gps coordinates from map"}>&raquo;&raquo;&raquo;</A>

            <br>


            <span class="bold">{trans("GPS latitude:")}</span>
            <INPUT class="form-control" ID="latitude" TYPE="text" NAME="nodedata[latitude]" VALUE="{if $nodeinfo.latitude}{$nodeinfo.latitude}{else}{/if}" {tip text="Enter device latitude (optional)"} trigger="latitude">
            <a href="javascript:void(0);" onClick="return gpscoordschoosewin(document.nodeadd.elements['nodedata[longitude]'], document.nodeadd.elements['nodedata[latitude]']);" {tip text="Click to select gps coordinates from map"}>&raquo;&raquo;&raquo;</A>

            <br>

            <IMG SRC="img/info1.gif" ALT="{trans("Description:")}">
            <TEXTAREA class="form-control" NAME="nodedata[info]" COLS="50" ROWS="5" {tip text="Enter additional information (optional)"}>{$nodedata.info}</TEXTAREA>

<br>

			<IMG SRC="img/{if ! $nodedata.access}no{/if}access.gif" ALT="">
			<SELECT class="form-control" NAME="nodedata[access]" {tip text="Select node status" trigger="access"}>
				<OPTION VALUE="1"{if $nodedata.access} SELECTED{/if}>{trans("connected<!singular>")}</OPTION>
				<OPTION VALUE="0"{if ! $nodedata.access} SELECTED{/if}>{trans("disconnected<!singular>")}</OPTION>
			</SELECT>

<br>

			<IMG SRC="img/warning{if !$nodedata.warning}off{else}on{/if}.gif" ALT="">
			<SELECT class="form-control" NAME="nodedata[warning]" {tip text="Set notice for node"}>
				<OPTION VALUE="1"{if $nodedata.warning} SELECTED{/if}>{trans("enabled")}</OPTION>
				<OPTION VALUE="0"{if ! $nodedata.warning} SELECTED{/if}>{trans("disabled")}</OPTION>
			</SELECT>
            </div>
        </div>
                        
			<A HREF="?m=nodescan{if $customerinfo.id}&ownerid={$customerinfo.id}{/if}">{trans("Scan")} <IMG SRC="img/search.gif" alt=""></A>
			<A HREF="javascript:document.nodeadd.submit();" ACCESSKEY="s">{trans("Submit")} <IMG SRC="img/save.gif" alt=""></A>
			<A HREF="?m={if $customerinfo.id}customerinfo&amp;id={$customerinfo.id}{else}nodelist{/if}">{trans("Cancel")} <IMG SRC="img/cancel.gif" alt=""></A><BR>
			<INPUT class="form-control" type="checkbox" name="nodedata[reuse]" id="reuse" value="ON" {if $nodedata.reuse}checked{/if}> <label for="reuse">{trans("Display this form again, when this node is saved")}</label>

</FORM>

<SCRIPT type="text/javascript">
    <!--
                        document.forms['nodeadd'].elements['nodedata[name]'].focus();

    function GenPasswd()
    {
        var passwd = new Array();
        var items = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        var length = {ConfigHelper::getConfig('phpui.nodepassword_length', '16')};
        if (length > 32)
            length = 32;

        for (var i = 0; i < length; i++)
        {
            n = Math.floor(Math.random() * items.length);
            passwd[i] = items.substring(n, n + 1);
        }

        document.forms['nodeadd'].elements['nodedata[passwd]'].value = passwd.join("");
    }

    function newmac()
    {
        var macscountelem = document.getElementById('macscount');
        var nr = macscountelem.value;
        var lastmacelem = document.getElementById('mac' + (nr - 1));
        var newrow = lastmacelem.parentNode.insertRow(lastmacelem.rowIndex + 1);
        newrow.id = 'mac' + nr;
        var newcell = newrow.insertCell(0);
        newcell.style.width = '100%';
        newcell.innerHTML = '<INPUT TYPE="TEXT" NAME="nodedata[macs][' + nr + ']" VALUE=""'
                + ' onmouseover="popup(\'{trans("Enter MAC address")}\')" onmouseout="pophide()">'
                + '<a href="javascript:void(0);" onClick="return macchoosewin(document.nodeadd.elements[\'nodedata[macs][' + nr + ']\']);"'
                + ' onmouseover="popup(\'{trans("Click to select MAC from the list")}\')" onmouseout="pophide()">&nbsp;&raquo;&raquo;&raquo;</A>';
        macscountelem.value = parseInt(nr) + 1;
    }

    function change_netdevice(id) {
        if (xjx.$('linktype').value == 1) {
            xjx.$('linktype').disabled = true;
            xjx.$('radiosector').disabled = true;
            xjx.$('linktechnology').disabled = true;
            xjx.$('linkspeed').disabled = true;
            xajax_getRadioSectors(id);
        }
    }

    function radiosectors_received(radiosectors) {
        var rselem = xjx.$('radiosector');
        var options = rselem.options;

        while (options.length)
            options.remove(0);
        options.add(new Option('- {trans("none")} -', 0));
        for (i = 0; i < radiosectors.length; i++)
            options.add(new Option(radiosectors[i].name, radiosectors[i].id));

        xjx.$('linktype').disabled = false;
        rselem.disabled = false;
        xjx.$('linktechnology').disabled = false;
        xjx.$('linkspeed').disabled = false;
    }

    function change_linktype(linktype) {
        linktype = parseInt(linktype);
        var options = xjx.$('linktechnology').options;
        while (options.length)
            options.remove(0);
        options.add(new Option('{trans("- unknown -")}', 0));
        switch (linktype) {
            case 0:
    {foreach $_LINKTECHNOLOGIES[0] as $linktechnologyidx => $linktechnology}
                options.add(new Option('{$linktechnology}', {$linktechnologyidx}));
    {/foreach}
                break;
            case 1:
    {foreach $_LINKTECHNOLOGIES[1] as $linktechnologyidx => $linktechnology}
                options.add(new Option('{$linktechnology}', {$linktechnologyidx}));
    {/foreach}
                break;
            case 2:
    {foreach $_LINKTECHNOLOGIES[2] as $linktechnologyidx => $linktechnology}
                options.add(new Option('{$linktechnology}', {$linktechnologyidx}));
    {/foreach}
                break;
        }
        xjx.$('radiosector').style.display = (linktype == 1 ? '' : 'none');
    }

    check_teryt('location', true);
    setNNProject();

    function set_lat_lon() {
        var loc = document.getElementById('location').value;
        var geocoder = new google.maps.Geocoder();
        geocoder.geocode({
            'address': loc}, function (results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
                document.getElementById('latitude').value = results[0].geometry.location.lat();
                document.getElementById('longitude').value = results[0].geometry.location.lng();
            }
        });
    }
    //-->
                    </SCRIPT>
